name: Publish Release

on:
  pull_request:
    types: [closed]
    branches:
      - master

permissions:
  contents: write

jobs:
  publish-release:
    name: Create Tag and Trigger Publish
    # Only run if:
    # 1. PR was merged (not just closed)
    # 2. Source branch starts with 'release/'
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from branch name
        id: version
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "Branch name: $BRANCH_NAME"

          # Extract version from release/vX.Y.Z
          if [[ "$BRANCH_NAME" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "version_tag=v${VERSION}" >> $GITHUB_OUTPUT
            echo "‚úÖ Extracted version: $VERSION"
          else
            echo "‚ùå Error: Invalid release branch name format"
            echo "Expected format: release/vX.Y.Z"
            exit 1
          fi

      - name: Checkout merged code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: master
          fetch-depth: 0
          # Use PAT instead of GITHUB_TOKEN to trigger publish-npm.yml workflow
          # See: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow
          token: ${{ secrets.RELEASE_PAT }}

      - name: Verify package.json version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"

          if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "‚ùå Error: package.json version mismatch"
            echo "Package version: $PACKAGE_VERSION"
            echo "Expected version: $EXPECTED_VERSION"
            exit 1
          fi
          echo "‚úÖ Version verified: $PACKAGE_VERSION"

      - name: Setup git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if tag already exists
        run: |
          TAG="${{ steps.version.outputs.version_tag }}"

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "‚ö†Ô∏è  Warning: Tag '$TAG' already exists"
            echo "This might be a re-run or tag was created manually"
            exit 1
          fi
          echo "‚úÖ Tag does not exist: $TAG"

      - name: Create and push tag
        env:
          # Use PAT to authenticate git push, triggering publish-npm.yml workflow
          # GITHUB_TOKEN would NOT trigger downstream workflows (security feature)
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          TAG="${{ steps.version.outputs.version_tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          echo "üìå Creating tag: $TAG"
          git tag -a "$TAG" -m "Release version $VERSION"

          echo "‚¨ÜÔ∏è  Pushing tag to origin"
          git push origin "$TAG"

          echo "‚úÖ Tag created and pushed: $TAG"
          echo "::notice title=Tag Created::Tag $TAG created and pushed to origin"

      - name: Publish workflow info
        run: |
          echo "üöÄ Release process initiated for v${{ steps.version.outputs.version }}"
          echo ""
          echo "Next steps (automatic):"
          echo "1. ‚è≥ publish-npm.yml workflow will be triggered by tag push"
          echo "2. üß™ Tests will run"
          echo "3. üì¶ Package will be published to npm with SLSA attestations"
          echo "4. üìù Draft GitHub Release will be created"
          echo ""
          echo "Monitor progress:"
          echo "https://github.com/${{ github.repository }}/actions"
          echo ""
          echo "::notice title=Release Triggered::publish-npm.yml workflow triggered for v${{ steps.version.outputs.version }}"
