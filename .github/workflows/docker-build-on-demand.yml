name: Docker Build On-Demand

# ARCHITECTURE: Permission Gating Pattern
#
# This workflow uses permission gating (single workflow with permission checks)
# instead of GitHub's recommended workflow_run pattern (two-workflow separation).
#
# This is a deliberate architectural decision prioritizing simplicity and speed
# for a trusted team environment. See docs/deployment/docker-on-demand.md for:
# - Security model and trade-offs
# - Comparison with workflow_run pattern
# - When to migrate to workflow_run
#
# Security layers:
# 1. Permission gating (write/admin access required)
# 2. Shallow clone (fetch-depth: 1)
# 3. Credential isolation (persist-credentials: false)
# 4. Minimal permissions (explicit per-job)
#
# Residual risk: Trusted users can execute code during build (accepted trade-off)

on:
  # Manual trigger with PR number input
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to build Docker image for'
        required: true
        type: number
      push_image:
        description: 'Push image to registry (default: true)'
        required: false
        type: boolean
        default: true

  # Trigger when specific label is added to PR
  pull_request:
    types: [labeled]

  # Trigger via PR comment
  issue_comment:
    types: [created]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Default permissions - minimal by default, each job defines its own
permissions:
  contents: read

jobs:
  # Check if this workflow should run
  check-trigger:
    name: Check Trigger Conditions
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      pr-ref: ${{ steps.check.outputs.pr-ref }}
      pr-sha: ${{ steps.check.outputs.pr-sha }}
      has-permission: ${{ steps.permission.outputs.has-permission }}
      actor: ${{ steps.permission.outputs.actor }}

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Check permissions
        id: permission
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HAS_PERMISSION="false"
          ACTOR=""

          # workflow_dispatch - always allowed (requires repo access to trigger)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            HAS_PERMISSION="true"
            ACTOR="${{ github.actor }}"
            echo "âœ“ workflow_dispatch trigger - permission granted to $ACTOR"

          # PR label trigger - check who added the label
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            ACTOR="${{ github.event.sender.login }}"
            echo "ðŸ” Checking permissions for $ACTOR (added label)"

            PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/$ACTOR/permission --jq '.permission')
            echo "  Permission level: $PERMISSION"

            if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
              HAS_PERMISSION="true"
              echo "  âœ“ $ACTOR has write access"
            else
              HAS_PERMISSION="false"
              echo "  âœ— $ACTOR does not have write access"
              echo "::warning::Docker build blocked: User $ACTOR attempted to trigger build without write access"
            fi

          # PR comment trigger - check who commented
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ACTOR="${{ github.event.comment.user.login }}"
            echo "ðŸ” Checking permissions for $ACTOR (commented)"

            PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/$ACTOR/permission --jq '.permission')
            echo "  Permission level: $PERMISSION"

            if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
              HAS_PERMISSION="true"
              echo "  âœ“ $ACTOR has write access"
            else
              HAS_PERMISSION="false"
              echo "  âœ— $ACTOR does not have write access"
              echo "::warning::Docker build blocked: User $ACTOR attempted to trigger build without write access"
            fi
          fi

          echo "has-permission=$HAS_PERMISSION" >> $GITHUB_OUTPUT
          echo "actor=$ACTOR" >> $GITHUB_OUTPUT

      - name: Check trigger conditions
        id: check
        if: steps.permission.outputs.has-permission == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          SHOULD_BUILD="false"
          PR_NUMBER=""
          PR_REF=""
          PR_SHA=""

          # workflow_dispatch trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "âœ“ Triggered via workflow_dispatch"
            SHOULD_BUILD="true"
            PR_NUMBER="${{ inputs.pr_number }}"

          # PR label trigger
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.action }}" = "labeled" ]; then
              LABEL="${{ github.event.label.name }}"
              if [ "$LABEL" = "docker:build" ]; then
                echo "âœ“ Triggered by 'docker:build' label"
                SHOULD_BUILD="true"
                PR_NUMBER="${{ github.event.pull_request.number }}"
              else
                echo "âœ— Label '$LABEL' is not 'docker:build', skipping"
              fi
            fi

          # PR comment trigger
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="$COMMENT_BODY"
            if [[ "$COMMENT" =~ ^/docker-build ]]; then
              # Check if comment is on a PR
              PR_URL="${{ github.event.issue.pull_request.url }}"
              if [ -n "$PR_URL" ]; then
                echo "âœ“ Triggered by '/docker-build' comment on PR"
                SHOULD_BUILD="true"
                PR_NUMBER="${{ github.event.issue.number }}"
              else
                echo "âœ— Comment is not on a PR, skipping"
              fi
            else
              echo "âœ— Comment does not contain '/docker-build', skipping"
            fi
          fi

          # Get PR details if we have a PR number
          if [ "$SHOULD_BUILD" = "true" ] && [ -n "$PR_NUMBER" ]; then
            echo "ðŸ“‹ Fetching PR #$PR_NUMBER details..."

            PR_DATA=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json headRefName,headRefOid)
            PR_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
            PR_SHA=$(echo "$PR_DATA" | jq -r '.headRefOid')

            echo "  Branch: $PR_REF"
            echo "  SHA: $PR_SHA"
          fi

          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr-ref=$PR_REF" >> $GITHUB_OUTPUT
          echo "pr-sha=$PR_SHA" >> $GITHUB_OUTPUT

          if [ "$SHOULD_BUILD" = "true" ]; then
            echo "::notice::Docker build will proceed for PR #$PR_NUMBER ($PR_REF @ $PR_SHA)"
          else
            echo "::notice::Workflow triggered but conditions not met, skipping Docker build"
          fi

  permission-denied:
    name: Permission Denied Notification
    runs-on: ubuntu-latest
    needs: [check-trigger]
    if: |
      always() &&
      needs.check-trigger.outputs.has-permission == 'false' &&
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request')

    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR about permission denial
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const prNumber = ${{ needs.check-trigger.outputs.pr-number || github.event.issue.number || github.event.pull_request.number }};
            const actor = '${{ needs.check-trigger.outputs.actor }}';
            const eventName = '${{ github.event_name }}';

            let body = '### âš ï¸ Docker Build Permission Denied\n\n';
            body += `@${actor}, you do not have permission to trigger Docker builds.\n\n`;
            body += '**Required permission:** Write access to the repository\n\n';
            body += '**What you can do:**\n';
            body += '- Ask a maintainer to trigger the build for you\n';
            body += '- Request write access to the repository if you are a regular contributor\n\n';
            body += '**For maintainers:** To trigger a build for this PR:\n';
            if (eventName === 'issue_comment') {
              body += '- Add the `docker:build` label\n';
              body += '- Or comment `/docker-build`\n';
            } else {
              body += '- Comment `/docker-build` on this PR\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [check-trigger]
    if: needs.check-trigger.outputs.should-build == 'true'

    permissions:
      contents: read
      packages: write
      id-token: write  # For Cosign keyless signing
      security-events: write  # For uploading Trivy SARIF results
      pull-requests: write  # For commenting on PR

    steps:
      - name: Add reaction to comment (if comment trigger)
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      # SECURITY NOTE: Checking out untrusted PR code in privileged context
      # Mitigation: Permission check in check-trigger job ensures only users
      # with write/admin access can trigger builds. This prevents external
      # contributors from executing malicious code.
      - name: Checkout PR branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ needs.check-trigger.outputs.pr-sha }}
          fetch-depth: 1  # Shallow clone - only need current commit
          persist-credentials: false  # Don't persist GitHub token in git config

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=pr-${{ needs.check-trigger.outputs.pr-number }},priority=1000
            type=sha,prefix=pr-${{ needs.check-trigger.outputs.pr-number }}-,priority=900

      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          file: Dockerfile
          push: ${{ inputs.push_image != false }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=false

      - name: Image digest
        run: |
          echo "::notice::Image pushed with digest ${{ steps.build-and-push.outputs.digest }}"
          echo "### ðŸ³ Docker Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build-and-push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

      # Vulnerability Scanning with Trivy
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build-and-push.outputs.digest }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@0499de31b99561a6d14a36a5f662c2a54f91beee
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # Image Signing with Cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad

      - name: Sign container image with Cosign
        env:
          DIGEST: ${{ steps.build-and-push.outputs.digest }}
        run: |
          echo "Signing image with digest: ${DIGEST}"
          cosign sign --yes --recursive \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST}"

      - name: Comment on PR with build results
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const prNumber = ${{ needs.check-trigger.outputs.pr-number }};
            const digest = '${{ steps.build-and-push.outputs.digest }}';
            const tags = `${{ steps.meta.outputs.tags }}`.split('\n').filter(t => t.length > 0);
            const success = '${{ job.status }}' === 'success';

            let body = success
              ? '### âœ… Docker Build Successful\n\n'
              : '### âŒ Docker Build Failed\n\n';

            if (success) {
              body += `**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`\n\n`;
              body += `**Tags:**\n`;
              tags.forEach(tag => {
                body += `- \`${tag}\`\n`;
              });
              body += `\n**Digest:** \`${digest}\`\n\n`;
              body += `**Pull command:**\n\`\`\`bash\n`;
              body += `docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${prNumber}\n`;
              body += `\`\`\`\n\n`;
              body += `**Security:** Image signed with Cosign and scanned with Trivy\n`;
            } else {
              body += `Build failed. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
