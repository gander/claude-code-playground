name: Docker Build and Publish

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:
  pull_request:
    branches:
      - 'master'
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-branch:
    name: Validate Tag is on Master Branch
    runs-on: ubuntu-latest
    # Only run branch validation for tag triggers
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      is-master: ${{ steps.check.outputs.is-master }}
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0  # Fetch full history to check branch ancestry

      - name: Check if tag was created from master branch
        id: check
        run: |
          # Get the commit SHA that the tag points to
          TAG_COMMIT=$(git rev-list -n 1 ${{ github.ref_name }})
          echo "Tag ${{ github.ref_name }} points to commit: $TAG_COMMIT"

          # Check if this commit is reachable from master
          if git merge-base --is-ancestor $TAG_COMMIT origin/master; then
            echo "âœ… Tag ${{ github.ref_name }} was created from master branch"
            echo "is-master=true" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tag ${{ github.ref_name }} was NOT created from master branch"
            echo ""
            echo "ðŸš« Docker deployment blocked for security reasons:"
            echo "   Tags must be created from the master branch to trigger releases"
            echo "   This prevents accidental releases from feature branches"
            echo ""
            echo "ðŸ”§ To fix this:"
            echo "   1. Ensure the tag is created from master branch"
            echo "   2. Delete this tag: git tag -d ${{ github.ref_name }} && git push origin :refs/tags/${{ github.ref_name }}"
            echo "   3. Checkout master: git checkout master"
            echo "   4. Create tag from master: git tag ${{ github.ref_name }} && git push origin ${{ github.ref_name }}"
            echo ""
            echo "is-master=false" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    runs-on: ubuntu-latest
    needs: [validate-branch]
    # Run if:
    # 1. Not a tag trigger (branch push or PR) - validate-branch will be skipped
    # 2. Tag trigger and validation passed
    if: |
      always() && (
        !startsWith(github.ref, 'refs/tags/') ||
        (needs.validate-branch.result == 'success' && needs.validate-branch.outputs.should-deploy == 'true')
      )

    permissions:
      contents: read
      packages: write
      id-token: write  # For Cosign keyless signing
      attestations: write  # For build attestations
      security-events: write  # For uploading Trivy SARIF results

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }},priority=1000
            type=edge,enable={{is_default_branch}},priority=900
            type=ref,event=branch,priority=800
            type=ref,event=pr,priority=700
            type=semver,pattern={{major}},priority=600
            type=semver,pattern={{major}}.{{minor}},priority=500
            type=semver,pattern={{major}}.{{minor}}.{{patch}},priority=400

      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.build-and-push.outputs.digest }}"

      # Vulnerability Scanning with Trivy
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build-and-push.outputs.digest }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@0499de31b99561a6d14a36a5f662c2a54f91beee
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # Image Signing with Cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad

      - name: Sign container image with Cosign
        env:
          DIGEST: ${{ steps.build-and-push.outputs.digest }}
        run: |
          echo "Signing image with digest: ${DIGEST}"
          cosign sign --yes --recursive \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST}"

      # Send webhook notification when 'latest' tag is published
      - name: Send webhook for latest tag publication
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          WEBHOOK_URL: ${{ secrets.DOCKER_PUBLISH_LATEST_WEBHOOK }}
          IMAGE_DIGEST: ${{ steps.build-and-push.outputs.digest }}
          CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "::warning::DOCKER_PUBLISH_LATEST_WEBHOOK secret not set, skipping webhook"
            exit 0
          fi

          if [ -z "$CLIENT_ID" ]; then
            echo "::warning::CF_ACCESS_CLIENT_ID secret not set, skipping webhook"
            exit 0
          fi

          if [ -z "$CLIENT_SECRET" ]; then
            echo "::warning::CF_ACCESS_CLIENT_SECRET secret not set, skipping webhook"
            exit 0
          fi

          echo "Sending webhook notification for latest tag publication..."

          # Send POST request to webhook
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            -H "CF-Access-Client-Id: $CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CLIENT_SECRET" \
            "$WEBHOOK_URL")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "::notice::âœ“ Webhook sent successfully (HTTP $HTTP_CODE)"
          else
            echo "::error::âœ— Webhook failed with HTTP $HTTP_CODE"
          fi
