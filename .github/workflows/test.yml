name: Test

on:
  pull_request:
    branches: [ "**" ]
  push:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  # Detect which files changed to conditionally run jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Check for file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          base: ${{ github.event.pull_request.base.ref || 'master' }}
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'biome.json'
              - 'Dockerfile*'
              - '.dockerignore'
            docs:
              - 'docs/**'
              - '*.md'
              - 'LICENSE'
            any:
              - '**'

  test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    name: Unit and Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '24'

      # npm must be newer than 11.5.1 for compatibility
      # Integrity hash ensures package authenticity from npm registry
      - name: Install npm 11.6.4
        run: npm install -g npm@11.6.4 --integrity sha512-ERjKtGoFpQrua/9bG0+h3xiv/4nVdGViCjUYA1AmlV24fFvfnSB7B7dIfZnySQ1FDLd0ZVrWPsLLp78dCtJdRQ==

      - name: Install dependencies
        run: npm ci

      - name: Verify lockfile integrity
        run: |
          if ! git diff --exit-code package-lock.json; then
            echo "❌ Error: package-lock.json was modified by npm ci"
            echo ""
            echo "This indicates a lockfile/package.json mismatch or npm version incompatibility."
            echo "Please regenerate package-lock.json with: npm install"
            echo ""
            echo "Changes detected:"
            git diff package-lock.json
            exit 1
          fi
          echo "✅ Lockfile integrity verified - no changes after npm ci"

      - name: Run type check
        run: npm run typecheck

      - name: Run linter
        run: npm run lint

      - name: Run unit tests
        run: npm run test:unit

      - name: Build
        run: npm run build

      - name: Run integration tests
        run: npm run test:integration

  test-mcp:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    name: MCP Test
    runs-on: ubuntu-latest
    outputs:
      total: ${{ steps.mcp-test.outputs.total }}
      passed: ${{ steps.mcp-test.outputs.passed }}
      failed: ${{ steps.mcp-test.outputs.failed }}
      skipped: ${{ steps.mcp-test.outputs.skipped }}
      success: ${{ steps.mcp-test-validate.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '24'

      # npm must be newer than 11.5.1 for compatibility
      # Integrity hashes ensure package authenticity from npm registry
      - name: Install tools
        run: |
          npm install -g npm@11.6.4 --integrity sha512-ERjKtGoFpQrua/9bG0+h3xiv/4nVdGViCjUYA1AmlV24fFvfnSB7B7dIfZnySQ1FDLd0ZVrWPsLLp78dCtJdRQ==
          npm install -g mcp-jest@1.2.0 --integrity sha512-Ruee/XiM6d8ALbHlim607+G4qU/t9OM79eQUxj8cuMoJAVRqWnT62qZJUI3jtyZIneZHYmmHxnYXe48sr8+Olg==

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Verify lockfile integrity
        run: |
          if ! git diff --exit-code package-lock.json; then
            echo "❌ Error: package-lock.json was modified by npm install"
            echo ""
            echo "This indicates a lockfile/package.json mismatch or npm version incompatibility."
            echo "Please regenerate package-lock.json with: npm install"
            echo ""
            echo "Changes detected:"
            git diff package-lock.json
            exit 1
          fi
          echo "✅ Lockfile integrity verified - no changes after npm install"

      - name: Build
        run: npm run build

      - name: Run MCP Jest and parse results
        id: mcp-test
        run: |
            mcp-jest --config tests/mcp-jest.json --reporter json --report-output report.json 
            
            {
              echo "total=$(jq '.total' report.json)"
              echo "passed=$(jq '.passed' report.json)"
              echo "failed=$(jq '.failed' report.json)"
              echo "skipped=$(jq '.skipped' report.json)"
            } >> "$GITHUB_OUTPUT"
            
            echo "Results: $(echo "$OUTPUT" | jq '.passed')/$(echo "$OUTPUT" | jq '.total') passed"
            echo "=== End raw output ==="
      - name: Validate test results
        id: mcp-test-validate
        run: |
          TOTAL=${{ steps.mcp-test.outputs.total }}
          PASSED=${{ steps.mcp-test.outputs.passed }}
          FAILED=${{ steps.mcp-test.outputs.failed }}
          SKIPPED=${{ steps.mcp-test.outputs.skipped }}
          
          if [ "$TOTAL" -gt 0 ] && [ "$PASSED" -eq "$TOTAL" ] && [ "$FAILED" -eq 0 ] && [ "$SKIPPED" -eq 0 ]; then
            echo "success=true" >> "$GITHUB_OUTPUT"
            echo "✅ All tests passed ($PASSED/$TOTAL)"
            exit 0
          else
            echo "success=false" >> "$GITHUB_OUTPUT"
            echo "❌ Tests failed - Passed: $PASSED/$TOTAL, Failed: $FAILED, Skipped: $SKIPPED"
            exit 1
          fi
