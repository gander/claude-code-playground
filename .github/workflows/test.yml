name: Test

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["master"]

permissions:
  contents: read

jobs:
  # Detect which files changed to conditionally run jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Check for file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'biome.json'
              - 'Dockerfile*'
              - '.dockerignore'
            docs:
              - 'docs/**'
              - '*.md'
              - 'LICENSE'
            any:
              - '**'

  test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    name: Unit and Integration Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [24]

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ matrix.node-version }}

      # npm must be newer than 11.5.1 for compatibility
      - name: Install npm 11.6.4
        run: npm install -g npm@11.6.4

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run typecheck

      - name: Run linter
        run: npm run lint

      - name: Run unit tests
        run: npm run test:unit

      - name: Build
        run: npm run build

      - name: Run integration tests
        run: npm run test:integration

  npm-package-test:
    name: NPM Package E2E Test
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: needs.changes.outputs.code == 'true'

    strategy:
      matrix:
        node-version: [24]

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ matrix.node-version }}

      # npm must be newer than 11.5.1 for compatibility
      - name: Install npm 11.6.4
        run: npm install -g npm@11.6.4

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install jq (required for testing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run npm package e2e tests
        run: ./tests/e2e/test-npm-package.sh
