name: Test

on:
  pull_request:
    branches: [ "**" ]
  push:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  # Detect which files changed to conditionally run jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Check for file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          base: ${{ github.event.pull_request.base.ref || 'master' }}
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'biome.json'
              - 'Dockerfile*'
              - '.dockerignore'
            docs:
              - 'docs/**'
              - '*.md'
              - 'LICENSE'
            any:
              - '**'

  test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    name: Unit and Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-and-install

      - name: Run Tests
        uses: ./.github/actions/run-tests

  test-mcp:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    name: MCP Test
    runs-on: ubuntu-latest
    outputs:
      total: ${{ steps.mcp-test.outputs.total }}
      passed: ${{ steps.mcp-test.outputs.passed }}
      failed: ${{ steps.mcp-test.outputs.failed }}
      skipped: ${{ steps.mcp-test.outputs.skipped }}
      success: ${{ steps.mcp-test-validate.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-and-install
        with:
          install-command: 'npm install --ignore-scripts'

      # npm must be newer than 11.5.1 for compatibility
      - name: Install tools
        run: npm install -g mcp-jest@1.2.0

      - name: Build
        run: npm run build

      - name: Run MCP Jest and parse results
        id: mcp-test
        run: |
            mcp-jest --config tests/mcp-jest.json --reporter json --report-output report.json 
            
            {
              echo "total=$(jq '.total' report.json)"
              echo "passed=$(jq '.passed' report.json)"
              echo "failed=$(jq '.failed' report.json)"
              echo "skipped=$(jq '.skipped' report.json)"
            } >> "$GITHUB_OUTPUT"
            
            echo "Results: $(echo "$OUTPUT" | jq '.passed')/$(echo "$OUTPUT" | jq '.total') passed"
            echo "=== End raw output ==="
      - name: Validate test results
        id: mcp-test-validate
        run: |
          TOTAL=${{ steps.mcp-test.outputs.total }}
          PASSED=${{ steps.mcp-test.outputs.passed }}
          FAILED=${{ steps.mcp-test.outputs.failed }}
          SKIPPED=${{ steps.mcp-test.outputs.skipped }}
          
          if [ "$TOTAL" -gt 0 ] && [ "$PASSED" -eq "$TOTAL" ] && [ "$FAILED" -eq 0 ] && [ "$SKIPPED" -eq 0 ]; then
            echo "success=true" >> "$GITHUB_OUTPUT"
            echo "✅ All tests passed ($PASSED/$TOTAL)"
            exit 0
          else
            echo "success=false" >> "$GITHUB_OUTPUT"
            echo "❌ Tests failed - Passed: $PASSED/$TOTAL, Failed: $FAILED, Skipped: $SKIPPED"
            exit 1
          fi
