name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.3.0 - without v prefix)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    name: Prepare Release Branch
    runs-on: ubuntu-latest

    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Error: Invalid version format '$VERSION'"
            echo "Expected format: X.Y.Z (e.g., 0.3.0)"
            exit 1
          fi
          echo "‚úÖ Version format validated: $VERSION"

      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if release branch exists
        run: |
          VERSION="${{ inputs.version }}"
          BRANCH="release/v${VERSION}"

          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "‚ùå Error: Branch '$BRANCH' already exists"
            echo "Please use a different version or delete the existing branch first"
            exit 1
          fi
          echo "‚úÖ Branch name available: $BRANCH"

      - name: Check if tag exists
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v${VERSION}"

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "‚ùå Error: Tag '$TAG' already exists"
            echo "This version has already been released"
            exit 1
          fi
          echo "‚úÖ Tag available: $TAG"

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v6.1.0
        with:
          node-version: '22'

      - name: Install npm 11.5.1
        run: npm install -g npm@11.5.1

      - name: Install dependencies
        run: npm ci

      - name: Setup git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run cliff-jumper to prepare release
        run: |
          VERSION="${{ inputs.version }}"
          echo "üì¶ Running cliff-jumper for version $VERSION"

          # cliff-jumper will:
          # 1. Create branch release/v$VERSION
          # 2. Bump package.json version
          # 3. Generate CHANGELOG.md entry
          # 4. Commit changes
          # 5. Push branch to origin
          # We skip tag creation (tag will be created after PR merge)
          npx cliff-jumper "$VERSION" --skip-tag --verbose

          echo "‚úÖ Release branch prepared: release/v${VERSION}"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          BRANCH="release/v${VERSION}"

          # Extract changelog entry for this version
          CHANGELOG_ENTRY=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d')

          if [ -z "$CHANGELOG_ENTRY" ]; then
            CHANGELOG_ENTRY="See CHANGELOG.md for details"
          fi

          gh pr create \
            --base master \
            --head "$BRANCH" \
            --title "release: v${VERSION}" \
            --body "$(cat <<'EOF'
          ## üì¶ Release v${{ inputs.version }}

          This PR was automatically generated by the prepare-release workflow.

          ### Changes

          ${CHANGELOG_ENTRY}

          ### Release Checklist

          - [ ] Review CHANGELOG.md entry
          - [ ] Verify package.json version bump
          - [ ] All tests passing
          - [ ] Ready to merge and publish

          **After merging this PR:**
          - Tag v${{ inputs.version }} will be automatically created
          - Package will be published to npm with SLSA attestations
          - Draft GitHub Release will be created
          EOF
          )"

          echo "‚úÖ Pull Request created for release/v${VERSION}"
          PR_URL=$(gh pr view "$BRANCH" --json url --jq '.url')
          echo "üîó PR URL: ${PR_URL}"
          echo "::notice title=Release PR Created::Release PR created at ${PR_URL}"
