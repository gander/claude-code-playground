name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.3.0 - without v prefix)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    name: Prepare Release Branch
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version }}

    steps:
      - name: Validate version format
        run: |
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Error: Invalid version format '$VERSION'"
            echo "Expected format: X.Y.Z (e.g., 0.3.0)"
            exit 1
          fi
          echo "‚úÖ Version format validated: $VERSION"

      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if release branch exists
        run: |
          BRANCH="release/v${VERSION}"

          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "‚ùå Error: Branch '$BRANCH' already exists"
            echo "Please use a different version or delete the existing branch first"
            exit 1
          fi
          echo "‚úÖ Branch name available: $BRANCH"

      - name: Check if tag exists
        run: |
          TAG="v${VERSION}"

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "‚ùå Error: Tag '$TAG' already exists"
            echo "This version has already been released"
            exit 1
          fi
          echo "‚úÖ Tag available: $TAG"

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v6.1.0
        with:
          node-version: '22'

      - name: Install npm 11.5.1
        run: npm install -g npm@11.5.1

      - name: Install dependencies
        run: npm ci

      - name: Setup git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare release branch and changelog
        run: |
          echo "üì¶ Preparing release v$VERSION"
          echo "Input version: $VERSION"

          # 1. Create and checkout release branch
          BRANCH="release/v${VERSION}"
          git checkout -b "$BRANCH"
          echo "‚úÖ Created branch: $BRANCH"

          # 2. Bump version in package.json (no git tag yet)
          # Workaround: cliff-jumper doesn't support custom version, so we set it manually
          npm version "$VERSION" --no-git-tag-version

          # Verify the version was set correctly
          ACTUAL_VERSION=$(node -p "require('./package.json').version")
          if [ "$ACTUAL_VERSION" != "$VERSION" ]; then
            echo "‚ùå Error: Version mismatch!"
            echo "Expected: $VERSION"
            echo "Actual: $ACTUAL_VERSION"
            exit 1
          fi
          echo "‚úÖ Bumped version to $VERSION in package.json (verified)"

          # 3. Generate CHANGELOG.md entry using cliff-jumper
          # Use --skip-automatic-bump because we already set the version manually
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          npx cliff-jumper --name "$PACKAGE_NAME" --skip-automatic-bump --verbose
          echo "‚úÖ Generated CHANGELOG.md entry"

          # 4. Ensure all changes are in a single commit
          # Check if cliff-jumper or npm created any commits
          COMMIT_COUNT=$(git rev-list --count HEAD ^master)
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $COMMIT_COUNT commit(s) - resetting to ensure single commit"
            # Reset commits but keep changes in working directory
            git reset --soft master
            # Unstage everything
            git reset HEAD
          fi

          # Clear any staged changes
          git reset HEAD --quiet || true

          # Stage all changes and create single commit
          echo "üìù Creating single commit with all changes..."
          git add package.json package-lock.json CHANGELOG.md

          # Verify all files are staged
          if ! git diff --cached --name-only | grep -q "package.json"; then
            echo "‚ùå Error: package.json not staged"
            exit 1
          fi
          if ! git diff --cached --name-only | grep -q "package-lock.json"; then
            echo "‚ùå Error: package-lock.json not staged"
            exit 1
          fi
          if ! git diff --cached --name-only | grep -q "CHANGELOG.md"; then
            echo "‚ùå Error: CHANGELOG.md not staged"
            exit 1
          fi

          git commit -m "chore: release v${VERSION}"
          echo "‚úÖ Committed all changes in single commit"

          # Verify exactly one commit exists
          FINAL_COMMIT_COUNT=$(git rev-list --count HEAD ^master)
          if [ "$FINAL_COMMIT_COUNT" -ne 1 ]; then
            echo "‚ùå Error: Expected 1 commit, found $FINAL_COMMIT_COUNT"
            git log --oneline HEAD ^master
            exit 1
          fi
          echo "‚úÖ Verified single commit created"

          # 5. Push to origin
          git push origin "$BRANCH"
          echo "‚úÖ Pushed branch: $BRANCH"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="release/v${VERSION}"

          # Extract changelog entry for this version
          CHANGELOG_ENTRY=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d')

          if [ -z "$CHANGELOG_ENTRY" ]; then
            CHANGELOG_ENTRY="See CHANGELOG.md for details"
          fi

          gh pr create \
            --base master \
            --head "$BRANCH" \
            --title "release: v${VERSION}" \
            --body "$(cat <<EOF
          ## üì¶ Release v${VERSION}

          This PR was automatically generated by the prepare-release workflow.

          ### Changes

          ${CHANGELOG_ENTRY}

          ### Release Checklist

          - [ ] Review CHANGELOG.md entry
          - [ ] Verify package.json version bump
          - [ ] All tests passing
          - [ ] Ready to merge and publish

          **After merging this PR:**
          - Tag v${VERSION} will be automatically created
          - Package will be published to npm with SLSA attestations
          - Draft GitHub Release will be created
          EOF
          )"

          echo "‚úÖ Pull Request created for release/v${VERSION}"
          PR_URL=$(gh pr view "$BRANCH" --json url --jq '.url')
          echo "üîó PR URL: ${PR_URL}"
          echo "::notice title=Release PR Created::Release PR created at ${PR_URL}"
# Trigger CI
