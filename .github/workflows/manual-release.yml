name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      push_tag:
        description: 'Push tag to trigger npm publish?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4.3.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v6.1.0
        with:
          node-version: '22'

      - name: Install latest npm
        run: npm install -g npm@11.5.1

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run typecheck

      - name: Run linter
        run: npm run lint

      - name: Run unit tests
        run: npm run test:unit

      - name: Build
        run: npm run build

      - name: Run integration tests
        run: npm run test:integration

      - name: Bump version
        run: |
          # Bump version using npm version (creates commit and tag)
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "Bumped version to: ${NEW_VERSION}"

      - name: Get new version
        id: get_version
        run: |
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=v${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New version: v${NEW_VERSION}"

      - name: Generate changelog
        run: |
          # Generate changelog using git-cliff
          npx git-cliff --tag ${{ steps.get_version.outputs.new_version }} --output CHANGELOG.md
          echo "Changelog generated"

      - name: Commit version bump and changelog
        run: |
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore(release): release osm-tagging-schema-mcp@${{ steps.get_version.outputs.new_version }}"
          git tag ${{ steps.get_version.outputs.new_version }}
          echo "Version bump and changelog committed"

      - name: Push release branch
        run: |
          BRANCH_NAME="release/${{ steps.get_version.outputs.new_version }}"
          git push --force origin HEAD:${BRANCH_NAME}
          echo "Release branch pushed: ${BRANCH_NAME}"

      - name: Push tag (optional)
        if: github.event.inputs.push_tag == 'true'
        run: |
          git push --force origin ${{ steps.get_version.outputs.new_version }}
          echo "Tag pushed: ${{ steps.get_version.outputs.new_version }}"
          echo "This will trigger the publish workflow."

      - name: Create Pull Request
        if: github.event.inputs.push_tag == 'false'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/${{ steps.get_version.outputs.new_version }}
          base: main
          title: 'release: ${{ steps.get_version.outputs.new_version }}'
          body: |
            ## Release ${{ steps.get_version.outputs.new_version }}

            This PR was automatically generated by the manual release workflow.

            ### Changes
            - Updated version in package.json to ${{ steps.get_version.outputs.new_version }}
            - Updated CHANGELOG.md with release notes
            - Created tag ${{ steps.get_version.outputs.new_version }}

            ### Next Steps
            1. Review the changes
            2. Merge this PR
            3. Manually push the tag to trigger npm publish:
               ```bash
               git push origin ${{ steps.get_version.outputs.new_version }}
               ```

            Or run the workflow again with "Push tag" option enabled.

      - name: Summary
        run: |
          echo "## Release Created Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.get_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: release/${{ steps.get_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.push_tag }}" = "true" ]; then
            echo "âœ… **Tag pushed**: Tag has been pushed and will trigger npm publish workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "â¸ï¸ **Tag NOT pushed**: Review the PR and push the tag manually" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To push the tag:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "git push origin ${{ steps.get_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
