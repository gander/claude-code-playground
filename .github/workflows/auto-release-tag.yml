name: Auto-Create Release Tag

on:
  pull_request:
    types: [closed]
    branches:
      - master

# Minimal permissions following principle of least privilege
permissions:
  contents: write  # Required for creating and pushing git tags
  issues: write    # Required for adding comments to PRs (issues API)

jobs:
  auto-tag-release:
    name: Create Release Tag from Merged Release PR
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract version from release branch name
        id: version
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          # Extract version from "release/vX.Y.Z" format
          VERSION=$(echo "$BRANCH_NAME" | sed 's|release/||')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted version from branch '$BRANCH_NAME': $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi
          echo "‚úÖ Version format validation passed: $VERSION"

      - name: Setup Node.js environment
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '22'

      - name: Verify package.json version matches release version
        run: |
          PACKAGE_VERSION="v$(node -p "require('./package.json').version")"
          RELEASE_VERSION="${{ steps.version.outputs.version }}"

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "‚ùå Version mismatch detected:"
            echo "  package.json version: $PACKAGE_VERSION"
            echo "  Release branch version: $RELEASE_VERSION"
            echo ""
            echo "This indicates the release-it process did not complete properly."
            echo "Please ensure package.json version was updated before merging the release PR."
            exit 1
          fi

          echo "‚úÖ Version validation passed: $PACKAGE_VERSION"

      - name: Check if tag already exists
        run: |
          TAG="${{ steps.version.outputs.version }}"
          if git rev-parse --verify "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "‚ùå Tag $TAG already exists"
            echo "This should not happen if the release process is working correctly."
            exit 1
          fi
          echo "‚úÖ Tag $TAG does not exist yet - proceeding with creation"

      - name: Create and push release tag
        run: |
          TAG="${{ steps.version.outputs.version }}"

          # Configure git user for tagging
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "$TAG" -m "Release $TAG

          Release created automatically from merged release PR #${{ github.event.pull_request.number }}.

          Generated by GitHub Actions workflow: ${{ github.workflow }}
          Commit: ${{ github.sha }}
          "

          # Push tag to origin
          git push origin "$TAG"

          echo "‚úÖ Successfully created and pushed tag: $TAG"
          echo "üöÄ Release workflows will now be triggered automatically"

      - name: Add comment to merged PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const tag = '${{ steps.version.outputs.version }}';
            const comment = `üè∑Ô∏è **Release tag created**: \`${tag}\`

            The release tag has been automatically created and pushed to the repository.

            üì¶ **Next steps:**
            - NPM publishing workflow will be triggered automatically
            - Docker image publishing workflow will be triggered automatically

            üîó **Track progress:**
            - [NPM Publishing Workflow](https://github.com/${{ github.repository }}/actions/workflows/publish-npm.yml)
            - [Docker Publishing Workflow](https://github.com/${{ github.repository }}/actions/workflows/publish-docker.yml)
            `;

            await github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });