name: Auto-Create Release Tag

on:
  pull_request:
    types: [closed]
    branches:
      - master

# Minimal permissions following principle of least privilege
permissions:
  contents: write       # Required for creating and pushing git tags
  issues: write         # Required for adding comments to PRs (issues API)
  pull-requests: write  # Required for PR operations

jobs:
  auto-tag-release:
    name: Create Release Tag from Merged Release PR
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract version from release branch name
        id: version
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          # Extract version from "release/vX.Y.Z" format
          VERSION=$(echo "$BRANCH_NAME" | sed 's|release/||')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted version from branch '$BRANCH_NAME': $VERSION"

      - name: Validate version format
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [[ ! "$RELEASE_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $RELEASE_VERSION"
            echo "Expected format: vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi
          echo "‚úÖ Version format validation passed: $RELEASE_VERSION"

      - name: Setup Node.js environment
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '22'

      - name: Verify package.json version matches release version
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          PACKAGE_VERSION="v$(node -p "require('./package.json').version")"

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "‚ùå Version mismatch detected:"
            echo "  package.json version: $PACKAGE_VERSION"
            echo "  Release branch version: $RELEASE_VERSION"
            echo ""
            echo "This indicates the release-it process did not complete properly."
            echo "Please ensure package.json version was updated before merging the release PR."
            exit 1
          fi

          echo "‚úÖ Version validation passed: $PACKAGE_VERSION"

      - name: Check if tag already exists
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          if git rev-parse --verify "refs/tags/$RELEASE_VERSION" >/dev/null 2>&1; then
            echo "‚ùå Tag $RELEASE_VERSION already exists"
            echo "This should not happen if the release process is working correctly."
            exit 1
          fi
          echo "‚úÖ Tag $RELEASE_VERSION does not exist yet - proceeding with creation"

      - name: Create and push release tag
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKFLOW_NAME: ${{ github.workflow }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Configure git user for tagging
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "$RELEASE_VERSION" -m "Release $RELEASE_VERSION

          Release created automatically from merged release PR #$PR_NUMBER.

          Generated by GitHub Actions workflow: $WORKFLOW_NAME
          Commit: $COMMIT_SHA
          "

          # Push tag to origin
          git push origin "$RELEASE_VERSION"

          echo "‚úÖ Successfully created and pushed tag: $RELEASE_VERSION"
          echo "üöÄ Release workflows will now be triggered automatically"

      - name: Add comment to merged PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        continue-on-error: true
        with:
          script: |
            const tag = '${{ steps.version.outputs.version }}';
            const comment = `üè∑Ô∏è **Release tag created**: \`${tag}\`

            The release tag has been automatically created and pushed to the repository.

            üì¶ **Next steps:**
            - NPM publishing workflow will be triggered automatically
            - Docker image publishing workflow will be triggered automatically

            üîó **Track progress:**
            - [NPM Publishing Workflow](https://github.com/${{ github.repository }}/actions/workflows/publish-npm.yml)
            - [Docker Publishing Workflow](https://github.com/${{ github.repository }}/actions/workflows/publish-docker.yml)
            `;

            try {
              await github.rest.issues.createComment({
                issue_number: ${{ github.event.pull_request.number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('‚úÖ Successfully added comment to PR #${{ github.event.pull_request.number }}');
            } catch (error) {
              console.log('‚ö†Ô∏è Failed to add comment to PR #${{ github.event.pull_request.number }}:', error.message);
              console.log('This is not critical - the tag was created successfully');
            }