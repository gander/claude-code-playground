name: Release Please

on:
  push:
    branches:
      - master

# Minimal permissions at workflow level (principle of least privilege)
permissions:
  contents: read

jobs:
  create-release:
    name: Create or Update Release PR
    runs-on: ubuntu-latest

    # Required permissions for release-please to create/update PRs and releases
    permissions:
      contents: write       # Required for creating releases and updating files
      pull-requests: write  # Required for creating/updating release PRs
      id-token: write      # Required for npm provenance

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          disable-sudo: 'true'
          egress-policy: 'audit'

      - name: Run Release Please
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release

  # This job executes ONLY after merging a Release PR
  publish-npm:
    name: Build, Publish, Tag and Release
    needs: create-release
    if: ${{ needs.create-release.outputs.release_created }}
    runs-on: ubuntu-latest

    # Required permissions for complete release process
    permissions:
      id-token: write       # Required for npm provenance and SLSA attestations
      attestations: write   # Required for build provenance attestations
      contents: write      # Required for creating tags and GitHub releases
      pull-requests: write # Required for PR comments

    outputs:
      version: ${{ needs.create-release.outputs.version }}
      version_tag: ${{ needs.create-release.outputs.tag_name }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          disable-sudo: 'true'
          egress-policy: 'audit'

      - name: Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-and-install

      - name: Verify package.json version matches release version
        env:
          RELEASE_VERSION: ${{ needs.create-release.outputs.version }}
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "âŒ Version mismatch detected:"
            echo "  package.json version: $PACKAGE_VERSION"
            echo "  Release Please version: $RELEASE_VERSION"
            echo ""
            echo "This should not happen with Release Please."
            echo "Please check the release-please configuration."
            exit 1
          fi

          echo "âœ… Version validation passed: $PACKAGE_VERSION"

      - name: Run Tests
        uses: ./.github/actions/run-tests

      - name: Verify build artifacts
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "Error: Build artifact dist/index.js not found"
            exit 1
          fi
          echo "âœ“ Build artifacts verified"

      - name: Generate SBOM (Software Bill of Materials)
        run: |
          # Use npx to avoid npm install -g (Scorecard Pinned-Dependencies)
          npx --yes @cyclonedx/cyclonedx-npm@4.1.0 --output-file sbom.json
          echo "âœ“ SBOM generated: sbom.json"

      - name: Create tarball for attestation
        run: |
          npm pack
          echo "TARBALL=$(ls -- *.tgz)" >> "$GITHUB_ENV"
          echo "âœ“ Package tarball created: $(ls -- *.tgz)"

      - name: Generate SLSA build provenance attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ env.TARBALL }}

      - name: Generate SLSA SBOM attestation
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: ${{ env.TARBALL }}
          sbom-path: sbom.json

      - name: Verify npm >= 11.6.4 for Trusted Publishers
        run: |
          CURRENT_NPM=$(npm --version)
          echo "Current npm version: $CURRENT_NPM"
          if [ "$(printf '%s\n' "11.6.4" "$CURRENT_NPM" | sort -V | head -n1)" = "11.6.4" ]; then
            echo "âœ“ npm version $CURRENT_NPM is sufficient (>= 11.6.4)"
          else
            echo "âŒ Error: npm version $CURRENT_NPM is too old"
            echo "npm >= 11.6.4 is required for Trusted Publishers"
            echo "Update Node.js version in workflow or manually install newer npm"
            exit 1
          fi

      - name: Publish to NPM with provenance (Trusted Publishers)
        run: npm publish --provenance --access public
        # Note: No NODE_AUTH_TOKEN needed - npm uses OIDC authentication automatically
        # Requires: id-token: write permission and npm >= 11.6.4

      - name: Upload dist/ artifact for Docker build
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        # NOTE: SHA pinning required for security. IDE warnings are false positives.
        with:
          name: dist-${{ needs.create-release.outputs.tag_name }}
          path: dist/
          retention-days: 7
          if-no-files-found: error

      - name: Create dist tarball for release
        run: |
          tar czf dist.tar.gz dist/
          echo "âœ“ Created dist.tar.gz ($(du -h dist.tar.gz | cut -f1))"

      - name: Update GitHub Release with dist artifact
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.create-release.outputs.tag_name }}
          files: dist.tar.gz
          body: |
            ## ğŸš€ Automatically Published Release

            Version `${{ needs.create-release.outputs.version }}` has been successfully published:

            ### ğŸ“¦ NPM Package
            - Package: [@gander-tools/osm-tagging-schema-mcp](https://www.npmjs.com/package/@gander-tools/osm-tagging-schema-mcp)
            - Install: `npx @gander-tools/osm-tagging-schema-mcp@${{ needs.create-release.outputs.version }}`

            ### ğŸ³ Docker Image
            Docker images built from this release use the same `dist/` artifact as the NPM package:
            - Pull: `docker pull ghcr.io/gander-tools/osm-tagging-schema-mcp:${{ needs.create-release.outputs.version }}`
            - Build artifact: `dist.tar.gz` (attached to this release)

            ### ğŸ” Provenance & Security
            This package was published with comprehensive supply chain security:

            #### NPM Provenance
            - [npm provenance](https://docs.npmjs.com/generating-provenance-statements) enabled
            - Verified build from GitHub Actions
            - Cryptographic attestations linking package to source

            #### SLSA Build Provenance
            - SLSA Level 3 build provenance attestations
            - Tamper-proof build metadata
            - Verifiable build environment and process

            #### SBOM (Software Bill of Materials)
            - CycloneDX SBOM generated and attested
            - Complete dependency transparency
            - Supply chain risk assessment

            ### ğŸ” Verification

            **Verify npm provenance:**
            ```bash
            npm audit signatures @gander-tools/osm-tagging-schema-mcp
            ```

            **Verify SLSA attestations:**
            ```bash
            gh attestation verify oci://ghcr.io/gander-tools/osm-tagging-schema-mcp:${{ needs.create-release.outputs.version }} --owner gander-tools
            ```

            ### ğŸ“‹ Release Process

            This release was created automatically by [Release Please](https://github.com/googleapis/release-please) based on [Conventional Commits](https://www.conventionalcommits.org/).

            **Atomic release process:**
            1. âœ… Build and test validation
            2. âœ… NPM package published with provenance
            3. âœ… Git tag created by Release Please
            4. âœ… GitHub release updated with artifacts

            See the changes below for detailed information.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log release info
        run: |
          echo "âœ… Successfully published version ${{ needs.create-release.outputs.version }}"
          echo "ğŸ“¦ Package: @gander-tools/osm-tagging-schema-mcp@${{ needs.create-release.outputs.version }}"
          echo "ğŸ·ï¸  Tag: ${{ needs.create-release.outputs.tag_name }}"
